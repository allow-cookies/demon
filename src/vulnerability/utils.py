from typing import Any

import requests

from dependency.models import Dependency
from vulnerability.models import Vulnerability


URL = (
    "https://raw.githubusercontent.com/pyupio/safety-db/master/data/insecure_full.json"
)


def fetch_from_safety_db():
    data: dict[str, list[dict[str, Any]]] = requests.get(URL).json()
    dependency_name_id_map = {
        name: index
        for name, index in Dependency.objects.all().values_list(
            Dependency.Fields.NAME, Dependency.Fields.ID
        )
    }
    Vulnerability.objects.filter(
        dependency__language=Dependency.DependencyLanguageChoices.PYTHON
    ).delete()
    vulnerabilities_scheduled_for_creation = set()
    for package, vulnerabilities in data.items():
        if package != "$meta":
            index = dependency_name_id_map.get(package)
            if index is None:
                dep = Dependency.objects.create(
                    name=package, language=Dependency.DependencyLanguageChoices.PYTHON
                )
                index = dep.id
                dependency_name_id_map[package] = index
            for vulnerability in vulnerabilities:
                vulnerabilities_scheduled_for_creation.add(
                    Vulnerability(
                        dependency_id=index,
                        version_range=vulnerability["v"],
                        description=vulnerability["advisory"],
                    )
                )
    Vulnerability.objects.bulk_create(
        objs=vulnerabilities_scheduled_for_creation, batch_size=100
    )
